<html><head>
<script type="text/javascript" src="util.js"></script>
<script type="text/javascript" src="creature.js"></script>
<script type="text/javascript" src="terrain.js"></script>
<script type="text/javascript">
map_elt = null;
los_map_elt = null;
kp_elt = null;

map = [];
vision_distance = 10;
render_distance = 11;
render_size = 2 * render_distance + 1;
event_distance = 20;
loc_x = 0;
loc_y = 0;

var player_los_map = [];
for (var x = 0; x <= render_size; x++) {
    player_los_map.push([]);
    for (var y = 0; y <= render_size; y++) {
	player_los_map[x].push(' ');
    }
}

function debug_map(map) {
    var s = '\n';
    s += '  '; for (var x = 0; x < map.length; x++) s += x % 10; s += '\n';
    s += '  '; for (var x = 0; x < map.length; x++) s += 'v'; s += '\n';
    for (var y = 0; y < map.length; y++) {
	s += y % 10 + '>';
	for (var x = 0; x < map[0].length; x++) {
	    s += map[x][y];
	}
	s += '<\n';
    }
    s += '  '; for (var x = 0; x < map.length; x++) s += '^'; s += '\n';
    return s;
}

function bresenham_line_algorithm(start_x, start_y, end_x, end_y, fn, payload) {
    var sx = end_x < start_x ? -1 : (end_x > start_x ? 1 : 0);
    var sy = end_y < start_y ? -1 : (end_y > start_y ? 1 : 0);
    var ax = sx * (end_x - start_x); var ay = sy * (end_y - start_y);
    var cx = start_x; var cy = start_y;
    var accum = 0;

    while (cx != end_x || cy != end_y) {
	if (ax > ay) {
	    cx += sx; accum += ay;
	    if (accum >= ax) {
		accum -= ax; cy += sy;
	    }
	}
	else {
	    cy += sy; accum += ax;
	    if (accum >= ay) {
		accum -= ay; cx += sx;
	    }
	}
	if (!fn(cx, cy, payload)) return;
    }
}

function player_los_fn_payload(end_x, end_y) {
    this.end_x = end_x; this.end_y = end_y;
    this.have_vision = 1;
}

function player_los_fn(x, y, payload) {
    var dx = x - loc_x; var dy = y - loc_y;
    var los_x = dx + render_distance, los_y = dy + render_distance;
    if (!payload.have_vision) {
	player_los_map[los_x][los_y] = '0';
	return 1;
    }
    if (dx * dx + dy * dy > vision_distance * vision_distance) {
	player_los_map[los_x][los_y] = '0';
	payload.have_vision = 0;
    }
    if (terrain_mapping[map[x][y]].los) {
	// I can see the object blocking LOS but not beyond
	player_los_map[los_x][los_y] = '1';
	payload.have_vision = 0;
    }
    player_los_map[los_x][los_y] = '1';
    return 1;
}

function compute_player_los(target_x, target_y, los_map) {
    return bresenham_line_algorithm(loc_x, loc_y, target_x, target_y,
	player_los_fn, new player_los_fn_payload(target_x, target_y));
}

function player_los() {
    var vision_horizon = vision_distance + 1;
    // for each cell at the border, compute the LOS to that cell
    for (var x = 0; x <= render_size; x++) {
	for (var y = 0; y <= render_size; y++) player_los_map[x][y] = ' ';
    }

    for (var y = loc_y - vision_horizon; y <= loc_y + vision_horizon + 1; y++) {
	compute_player_los(loc_x - vision_horizon, y, player_los_map);
	compute_player_los(loc_x + vision_horizon + 1, y, player_los_map);
    }
    for (var x = loc_x - vision_horizon; x <= loc_x + vision_horizon; x++) {
	compute_player_los(x, loc_y - vision_horizon, player_los_map);
	compute_player_los(x, loc_y + vision_horizon + 1, player_los_map);
    }
	//los_map_elt.innerHTML = '<pre>' + debug_map(player_los_map) + '</pre>';
}

function paint_map() {
    var s = '';
    player_los(vision_distance);
    for (var y = -render_distance; y <= render_distance; y++) {
	for (var x = -render_distance; x <= render_distance; x++) {
	    if (!x && !y) { s += '@'; continue; }
	    var map_x = loc_x + x;
	    var map_y = loc_y + y;
	    if (player_los_map[x + render_distance][y + render_distance] == '0') {
		s += ' ';
		continue;
	    }
	    for (i = 0; i < creature_list.length; i++) {
		if (creature_list[i].x == map_x
			&& creature_list[i].y == map_y) {
		    s += creature_list[i].char; break;
		}
	    }
	    if (i < creature_list.length) continue;
	    s += map[map_x][map_y];
	}
	s += '\n';
    }
    map_elt.innerHTML = '<pre>' + s + '</pre>';
}

function place_terrain(x, y) {
    map[x][y] = pick_terrain(x, y);
}

function check_map() {
    var width = map.length;
    var height = width ? map[0].length : 0;

    var x, y;
    while(loc_x < event_distance) {
	// add to the left
	map.unshift([]);
	for (y = 0; y < height; y++) { map[0].push(' '); }
	for (y = 0; y < height; y++) place_terrain(0, y);
	loc_x++;
	width++;
    }
    while(loc_x + event_distance >= width) {
	// add to the right
	map.push([]);
	for (y = 0; y < height; y++) { map[width].push(' '); }
	for (y = 0; y < height; y++) place_terrain(width, y);
	width++;
    }
    while(loc_y < event_distance) {
	// add to the top
	for (x = 0; x < width; x++) map[x].unshift(' ');
	for (x = 0; x < width; x++) place_terrain(x, 0);
	loc_y++;
	height++;
    }
    while(loc_y + event_distance >= height) {
	// add to bottom
	for (x = 0; x < width; x++) map[x].push(' ');
	for (x = 0; x < width; x++) place_terrain(x, height);
	height++;
    }
}

highlighted_keys = [];
interval_var = null;

function unhighlight(key) {
//    kp_elt.innerHTML = '';
    while (e = highlighted_keys.pop()) {
	e.style.background = 'white';
    }
    window.clearInterval(interval_var);
}

function highlight(key) {
    elt = document.getElementById(key);
    elt.style.background = 'black';
    highlighted_keys.push(elt);
    interval_var = window.setInterval(unhighlight, 200);
}

function ticktock() {
    add_creatures();
    move_creatures(1.0);
    paint_map();
}

function move(dx, dy) {
    var new_x = loc_x + dx; var new_y = loc_y + dy;
    if (terrain_mapping[map[new_x][new_y]].move) {
	loc_x = new_x; loc_y = new_y;
	check_map();
    }
    ticktock();
}

function keypress(k) {
    switch(k) {
	case 'w': highlight(k); move(0, -1); break;
	case 'a': highlight(k); move(-1, 0); break;
	case 's': highlight(k); move(0, 1); break;
	case 'd': highlight(k); move(1, 0); break;
    }
}

function kp(e) {
    kp_elt.innerHTML = 'charCode = ' + e.charCode + ' keyCode = ' + e.keyCode;
    switch(e.charCode) {
	case 0: switch(e.keyCode) { // re-map arrow keys to wasd
	    case 37: keypress('a'); return;
	    case 38: keypress('w'); return;
	    case 39: keypress('d'); return;
	    case 40: keypress('s'); return;
	}
	case 97: keypress('a'); return;
	case 100: keypress('d'); return;
	case 115: keypress('s'); return;
	case 119: keypress('w'); return;
    }
}

function go() {
    map_elt = document.getElementById('map');
    kp_elt = document.getElementById('kp');
    los_map_elt = document.getElementById('los');
    check_map();
    paint_map();
    document.onkeypress = kp;
}
</script>
<style type="text/css">
span.key { border-style:solid; border-width: medium; }
</style>
</head><body onload="go()">
<table border="0"><tr><td>
<div id="map">
</div>
</td><td>
<div id="los">
</div>
</td></tr></table>
<table border=0>
<tr>
    <td></td>
    <td align="center"><span id="w" class="key" onclick=keypress("w")>W</span><br/>up</td>
    <td></td>
</tr><tr>
    <td align="center"><span id="a" class="key" onclick=keypress('a')>A</span><br/>left</td>
    <td></td>
    <td align="center"><span id="d" class="key" onclick=keypress('d')>D</span><br/>right</td>
</tr>
<tr>
    <td></td>
    <td align="center"><span id="s" class="key" onclick=keypress('s')>S</span><br/>down</td>
    <td></td>
</tr></table>
</div>
<div id="kp">
</div>
</body></html>
